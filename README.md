
# Прогнозирование преступности с применением модели SARIMA

## Постановка задачи
Проанализировать временной ряд, применить к нему модель SARIMA и с помощью спрогнозировать его.
В качестве данных будем использовать открытые данные по преступности в России за 2003-2020 гг. Будем прогнозировать на год вперед.

## План работы 
1.	Актуальность такой задачи
2.	Рассказать про то, что такое временные ряды, в чем их особенности
3.	Автокорреляция, частичная корреляция, коррелограмма и стационарность
4.	Подготовка временного ряда для применения модели
5.	Рассказать про семейство моделей ARIMA
6.	Подбор параметров и реализация модели
7.	Прогнозирование временного ряда

## Актуальность задачи
В настоящее время задача прогнозирования очень часто используется. Очевидный пример – прогноз погоды на основе исторических данных. Вообще прогнозирование чего-либо на основании исторических данных сама по себе уникальная задача. На бирже таким образом прогнозируют котировки финансовых активов.

Я решил, что очень интересно будет спрогнозировать преступность, предположить какое количество преступлений будет совершено в какой-то промежуток времени в будущем. Сама по себе, преступность имеет довольно цикличный характер, все мы знаем, что в какой-то период преступлений больше, чем в другой.

Использовать я буду математическую модель из семейства моделей ***ARIMA***. С помощью этой модели я постараюсь построить временной ряд, который будет похож на исходный и который будет учитывать все особенности исходного временного ряда, а также сделаю прогноз на основе этих данных.

## Временные ряды 
> **Временным рядом** называется последовательность значений признака $y$, измеряемого через постоянные временные интервалы:
![formula1.png](https://latex.codecogs.com/gif.latex?y_1%2C%20y_2%2C%20...%2C%20y_T%2C%20...%20%5C%3B%20%5C%3B%20%5C%3B%20%5C%3B%20%5C%3B%20y%20%5Cin%20%5Cmathbb%7BR%7D)

Вот так выглядит, к примеру, выглядит график временного ряда: 
![theft.png](https://sun9-40.userapi.com/n1QUh2_i5Lh7DvZmpqtSFHdKGPdvx-yDVK1c7A/JnBYHUJVqPs.jpg)
На этом графике изображено то, как менялось количество преступлений за месяц, связанных с кражами с 2003 года. Как видно, график «зигзагообразен» и имеет такую особенность, как цикличность (период – один год).

Вообще, в задаче анализа временных рядов не исключается, что данные в будущем каким-то образом связаны с данными в прошлом. В машинном обучении, наоборот, считается, что анализируемые данные – это выборки, то есть независимые друг от друга наблюдения.

### Особенности временных рядов
* Тренд – плавное долгосрочное изменение уровня ряда. 
* Сезонность — циклические изменения уровня ряда с постоянным периодом.
* Остаток — непрогнозируемая случайная компонента ряда. Сюда включены все те характеристики временного ряда, которые сложно измерить.

А вот так будет выглядеть декомпозиция на эти составляющие графика числа краж. Важно отметить, что существует большое множество шаблонов периодичности, и на этом рисунке изображён один из них:
![stl.png](https://sun9-66.userapi.com/8dM6JEZH1qFAt3h-6MlQhrASW2UE_zuwTPWDZQ/7vyVI3rhKGk.jpg)
Тренд убывающий, сезонность годичная.

### Автокорреляция и стационарность
> **Автокорреляция** — это количественная характеристика сходства между значениями ряда в соседних точках, которая задаётся следующим соотношением:
![formula2.png](https://sun9-10.userapi.com/oQLDlzjc6fljB5s2PuKm_MgQYtvx7BN1Ka-u-A/jipQ_OC1y68.jpg)
 
Автокорреляция — это частный случай корреляции Пирсона между исходным рядом и его версией, сдвинутой на несколько отсчётов. 
> Количество отсчётов $\gamma$, на которое сдвинут ряд, называется **лагом автокорреляции**. 

Вычислить автокорреляцию по выборке можно, заменив в формуле математическое ожидание на выборочное среднее, а дисперсию — на выборочную дисперсию:
![formula3.png](https://sun9-36.userapi.com/RGli2qKz8L0klGgSWdpNELFm7Zi2no2GO8n5vQ/mvG-cHZ5IeY.jpg)

Анализировать величину автокорреляции при разных значениях лагов удобно с помощью графика, который называется **коррелограммой**. По оси ординат на нём откладывается автокорреляция, а по оси абсцисс — размер лага $\gamma$. Для нашего ряда она выглядит так:
![autocorr.png](https://sun9-33.userapi.com/Ro26paI7lEm9rVQW6LQOjK2gjOpI3c3rlTeOTg/meCMzQC4dr8.jpg)
На коррелограмме помимо значений автокорреляционной функции, также изображена некая область, — это **коридор значимости отличия корреляции от нуля**. По факту, все автокорреляции, которые изображены вне этого коридора, значимо отличаются от нуля.

Как и для обычной корреляции Пирсона, формально значимость можно вычислить с помощью критерия Стьюдента.
Еще одно важное свойство временных рядов – это стационарность. 
> Временной ряд $y_1, y_2, ..., y_T$ называется **стационарным**, если для $\forall  s$ распределение $$y_t, y_{t+1}, ..., y_{t+s}$$ не зависит от $t$, то есть его свойства не зависят от времени. 

Формально гипотезу о стационарности можно проверить с помощью критерия Дики-Фуллера. 
Реализации критериев Стьюдента и Дики-Фуллера имеются во многих статистических пакетах.

### Подготовка ряда к применению модели
Заранее скажу, что для применения моделей из класса *ARIMA*, необходимо временной ряд привести к стационарному виду. Алгоритм довольно простой и выглядит так:
1.	Если ряд обладает довольно большой дисперсией, то применяют логарифмирующее преобразование. Оно удобно тем, что оно обратимо и уменьшает, как ни странно, дисперсию.
2. Последовательно дифференцируем ряд: переходим к попарным разностям значений ряда:
![diff.png](https://latex.codecogs.com/gif.latex?y%27%20%3D%20y_t%20-%20y_%7Bt-1%7D)
Если ряд обладает ярко выраженной сезонностью, то рекомендуется выполнить сначала *сезонное дифференцирование*:
![seasondiff.png](https://latex.codecogs.com/gif.latex?y%27%20%3D%20y_t%20-%20y_%7Bt-s%7D)
 
Проверяем с помощью статистических критериев стационарность ряда.

## Семейство моделей *ARIMA*
### Модель авторегрессии *AR\(p\)*
![ar.png](https://latex.codecogs.com/gif.latex?y_t%20%3D%20%5Cvarphi_%7B0%7D%20&plus;%20%5Cvarphi_%7B1%7D%5C%2C%20y_%7Bt-1%7D%20&plus;%20%5Cvarphi_%7B2%7D%5C%2C%20y_%7Bt-2%7D%20&plus;%20...%20&plus;%20%5Cvarphi_%7Bp%7D%5C%2C%20y_%7Bt-p%7D%20&plus;%20%5Cvarepsilon_%7Bt%7D)
В этом регрессионном уравнении $y_t$ — это *отклик*; $y_{t-1}, y_{t-2}, ..., y_{t-p}$ — признаки; $\varphi_0,\varphi_1,\varphi_2,...,\varphi_p$ — *параметры модели*, которые необходимо оценить; $\varepsilon_t$ — *шумовая компонента*, описывает отклонения значений ряда от данного уравнения.

### Модель скользящего среднего *MA\(q\)*
![ma.png](https://latex.codecogs.com/gif.latex?y_t%20%3D%20%5Ctheta_%7B0%7D%20&plus;%20%5Cvarepsilon_%7Bt%7D%20&plus;%20%5Ctheta_%7B1%7D%5C%2C%20%5Cvarepsilon_%7Bt-1%7D%20&plus;%20%5Ctheta_%7B2%7D%5C%2C%20%5Cvarepsilon_%7Bt-2%7D%20&plus;%20...%20&plus;%20%5Ctheta_%7Bq%7D%5C%2C%20%5Cvarepsilon_%7Bt-q%7D)
где $\varepsilon_t, \varepsilon_{t-1}, ..., ε_{t-q}$ — значения *шума* в $q$ предыдущих моментов времени;
$\theta_0, \theta_1, \theta_2, ...,\theta_q$ — это параметры модели, которые необходимо оценить.
 
В ней предполагается, что значение ряда $y_t$ — это линейная комбинация $q$ последних значений шумовой компоненты.

### *ARMA\(p, q\)*
Это комбинация двух вышеописанных моделей:
![arma.png](https://latex.codecogs.com/gif.latex?y_t%20%3D%20%5Calpha%20&plus;%20%5Cvarphi_%7B1%7D%5C%2C%20y_%7Bt-1%7D%20&plus;%20%5Cvarphi_%7B2%7D%5C%2C%20y_%7Bt-2%7D%20&plus;%20...%20&plus;%20%5Cvarphi_%7Bp%7D%5C%2C%20y_%7Bt-p%7D%20&plus;%20%5Cvarepsilon_%7Bt%7D%20&plus;%20%5Ctheta_%7B1%7D%5C%2C%20%5Cvarepsilon_%7Bt-1%7D%20&plus;%20%5Ctheta_%7B2%7D%5C%2C%20%5Cvarepsilon_%7Bt-2%7D%20&plus;%20...%20&plus;%20&plus;%20%5Ctheta_%7Bq%7D%5C%2C%20%5Cvarepsilon_%7Bt-q%7D)

### *ARIMA\(p, d, q\)*
По сути, это обобщение моделей класса *ARMA*, с той идеей, что при помощи дифференцирования нестационарный ряд можно превратить в стационарный.
Модель *ARIMA*$(p, d, q)$ — это модель *ARMA*$(p, q)$ для $d$ раз продифференцированного ряда.

### *SARMA\(p, q\) × \(P, Q, S\)*
Рассмотрим ряд с выраженной сезонностью (пусть период равен $S$). Возьмём модель *ARMA*$(p, q)$:
![arma.png](https://latex.codecogs.com/gif.latex?y_t%20%3D%20%5Calpha%20&plus;%20%5Cvarphi_%7B1%7D%5C%2C%20y_%7Bt-1%7D%20&plus;%20%5Cvarphi_%7B2%7D%5C%2C%20y_%7Bt-2%7D%20&plus;%20...%20&plus;%20%5Cvarphi_%7Bp%7D%5C%2C%20y_%7Bt-p%7D%20&plus;%20%5Cvarepsilon_%7Bt%7D%20&plus;%20%5Ctheta_%7B1%7D%5C%2C%20%5Cvarepsilon_%7Bt-1%7D%20&plus;%20%5Ctheta_%7B2%7D%5C%2C%20%5Cvarepsilon_%7Bt-2%7D%20&plus;%20...%20&plus;%20&plus;%20%5Ctheta_%7Bq%7D%5C%2C%20%5Cvarepsilon_%7Bt-q%7D)
и добавим к этой модели $P$ авторегрессионных компонент, но не предыдущих, а с шагом, равным периодом сезонности:
![plusar.png](https://latex.codecogs.com/gif.latex?&plus;%20%5Cvarphi_%7BS%7D%5C%2C%20y_%7Bt-S%7D%20&plus;%20%5Cvarphi_%7B2S%7D%5C%2C%20y_%7Bt-2S%7D%20&plus;%20...%20&plus;%20%5Cvarphi_%7BPS%7D%5C%2C%20y_%7Bt-PS%7D)
и $Q$ компонент скользящего среднего, также с шагом, равным периодом сезонности:
![plusma.png](https://latex.codecogs.com/gif.latex?&plus;%20%5Ctheta_%7BS%7D%5C%2C%20%5Cvarepsilon_%7Bt-S%7D%20&plus;%20%5Ctheta_%7B2S%7D%5C%2C%20%5Cvarepsilon_%7Bt-2S%7D%20&plus;%20...%20&plus;%20&plus;%20%5Ctheta_%7BQS%7D%5C%2C%20%5Cvarepsilon_%7Bt-QS%7D)
Результатом станет модель *SARMA*$(p, q)$ × $(P, Q, S)$

### *SARIMA\(p, d, q\) × \(P, D, Q, S\)*
Эта модель — обобщение модели *SARMA*$(p, q)$ × $(P, Q, S)$ для ряда, к которому $d$ раз было применено обычное дифференцирование и $D$ раз — сезонное.

## Подбор параметров и реализация модели
Рассмотрим уравнение для модели *SARIMA* (оно имеет вид, похожий уравнению модели *SARMA*). В нем имеется несколько групп параметров, с которыми нам нужно разобраться.

Параметры $\alpha, \varphi, \theta$ являются коэффициентами регрессионного уравнения и подбираются так, чтобы минимизировалась среднеквадратическая ошибка. В качестве начального приближения можно взять нули.

Теперь перейдем к группе параметров $d, D, q, Q, p, P, S$ — их еще называют гиперпараметрами, так как они задают структуру модели.
#### Параметры $d, D$
Как уже говорилось, любой нестационарный ряд можно преобразовать в стационарный путём дифференцирования. Эти параметры как раз-таки и отвечают за то, сколько раз нужно продифференцировать временной ряд: $D$ раз сезонным образом и $d$ раз обычным. 

#### Параметры $q, Q, p, P$
К сожалению, эти гиперпараметры нет смысла выбирать из принципа максимума правдоподобия. Например, чем больше значение параметра $p$, тем больше авторегрессионных компонент в итоговом уравнении, тем больше параметров $\varphi$ и тем лучше это уравнение будет описывать данные.

С увеличением значений этих параметров мы делаем модель более сложной и таким образом значение правдоподобия будет только увеличиваться. Поэтому для сравнения моделей с разным количеством параметров необходим другой критерий. В качестве искомого критерия можно использовать, например, критерий Акаике:

![aic.png](https://latex.codecogs.com/gif.latex?AIC%20%3D%20-2%5C%2C%20ln%20L%20&plus;%202%20k)

где $L$ — правдоподобие, $k=P+Q+p+q+1$ — число параметров в модели.

> *Оптимальной по критерию Акаике* будет модель с наименьшим значением этого критерия. Такая модель, с одной стороны, будет достаточно хорошо описывать данные, а с другой — содержать не слишком большое количество параметров.

Начальные приближения для этих параметров можно выбрать с помощью автокорреляционной функции.
* Начальное значение для параметра $Q \cdot S$ даёт номер последнего сезонного лага, при котором автокорреляция значима. Параметр $q$ задаётся номером последнего несезонного лага, при котором автокорреляция значима. 
* Значения параметров $p, P$ подбираются с использованием частичной автокорреляционной функции.

> **Частичная автокорреляция** — это автокорреляция после снятия авторегрессии предыдущего порядка. 

Например, чтобы подсчитать частичную автокорреляцию с лагом $\gamma=2$, требуется построить авторегрессию порядка $1$, вычесть эту авторегрессию из ряда и подсчитать автокорреляцию на полученных остатках.

* Начальное приближение для параметра $P \cdot S$ задаёт номер последнего сезонного лага, при котором частичная автокорреляция значима. Аналогично, $p$ задаётся как номер последнего несезонного лага, при котором частичная автокорреляция значима.

### Программная реализация
Используется статистический пакет `statmodels` для языка программирования Python. Графики строятся при помощи библиотек `matplotlib.pyplot` и `seaborn`, табличные данные обрабатываются при помощи библиотек `pandas`, `numpy` и `scipy`.

Данные взяты с сайта МВД и представляют собой таблицу по различным категориям преступлений. Как я и сказал в самом начале, будем использовать данные по количеству краж с 2003 года по настоящее время. Выведем на экран временной ряд:
![theft.png](https://sun9-40.userapi.com/n1QUh2_i5Lh7DvZmpqtSFHdKGPdvx-yDVK1c7A/JnBYHUJVqPs.jpg)
По графику видны убывающий тренд и ярко выраженная сезонность с периодом в $S=12$ месяцев. Для критерия Дики-Фуллера $p_{value} \approx 0.63 \geqslant 0.05$. Это значит, что у нас есть основания *не отвергать* нулевую гипотезу о нестационарности ряда.

Стандартное отклонение для ряда составляет около 25376 краж. Максимальное значение было в августе 2006 года и составляло 153394 кражи за месяц, минимальное – 50155 краж в декабре 2017 года. Безусловно дисперсия очень большая, поэтому нам нужно её стабилизировать, применим логарифмирующее преобразование:
![logtheft.png](https://sun9-55.userapi.com/zR2d82zIw_d_OZiGvzBv55BPwvmxVZXDIwaMDg/ESQHmB5_wdE.jpg)
Теперь значение стандартного отклонения составило около $0.27$. При этом ряд продолжает оставаться нестационарным ($p_{value} \approx 0.61$). 

Нам нужно продифференцировать ряд: применим для него сезонное дифференцирование и обычное дифференцирование. Посмотрим на декомпозицию нового ряда:
![difftheft.png](https://sun9-71.userapi.com/yNZiDLsWhOBfYMMUfPs2zSnDyUBj7WOdnDm_IQ/Xq9AdpQUxbw.jpg)
Теперь у нас $p_{value} \approx 0$. Это значит, что мы можем отвергнуть гипотезу о нестационарности ряда. Наш ряд готов и нам нужно подобрать гиперпараметры модели.

Покажем графики автокорреляции и частичной автокорреляции (*ACF* и *PACF*):
![acf.png](https://sun9-66.userapi.com/sI2Ln6BinlId9wZs4vMxCd67HAybCtlckPME0A/V5H4RtB_L8M.jpg)
![pacf.png](https://sun9-21.userapi.com/R99fbjmJpLA9mgZAhGneLbw29r2ia3NzGscvvA/lK1tu3ZgHl0.jpg)
* $$Q=4$$ – последний значимый лаг на ACF, кратный сезонности
* $$q=2$$ – последний значимый лаг на ACF, меньший чем значение сезонности
* $$P=1$$ – последний значимый лаг на PACF, кратный сезонности
* $$p=3$$ – последний значимый лаг на PACF, меньший чем значение сезонности

Эти начальные приближения мы задаём для нашей модели. Прогоним модель по множеству наборов параметров (их 120) и выведем таблицу лучших по критерию Акаике наборов гиперпараметров модели (чем меньше его значение, тем лучше):
(p, q, P, Q)  | aic
------------- | -------------
(0, 2, 0, 4)  |	-1280.110981
(3, 0, 0, 4)  |	-1279.502785
(2, 0, 0, 2)  |	-1279.225721
(3, 0, 0, 2)  |	-1278.845676
(2, 1, 0, 1)  |	-1278.508542

Покажем на сравнительном графике значения смоделированного временного ряда с лучшим набором параметров и фактического:
![compare.png](https://sun9-16.userapi.com/BbPwJ_PEunbCSc-5dmElfsfnR5vfYQXVVwpb7Q/YnmfkZSA8uA.jpg)
Значение средней ошибки аппроксимации составляет около 4,39%.

А так выглядит прогноз нашей модели:
месяц |	forecast
------- | ------------
2020-01 | 51172.628821
2020-02 | 56826.322891
2020-03 | 62231.360912
2020-04 | 65239.190677
2020-05 | 67551.761575
2020-06 | 69184.612752
2020-07 | 65744.387659
2020-08 | 65783.492993
2020-09 | 63887.455159
2020-10 | 74869.285371
2020-11 | 57004.413954
2020-12 | 62139.382748

А так график:
![forecast.png](https://sun9-66.userapi.com/YGPnvJHLtbdt6OOTyUZRv5P-hwPIE1tMA1mA1w/0TJKOAwwAew.jpg)

### Заключение
В этой лабораторной работе я проанализировал временной ряд, изучил модели из класса *SARIMA*, и смоделировал временной ряд, используя эту модель. Так же мы построили прогноз на следующий год, который должен показать результат, близкий к реальному (так как модель отображает некоторые особенности временного ряда, например, скачок числа краж осенью)










